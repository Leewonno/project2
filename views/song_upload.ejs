<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>곡 업로드</title>
</head>
<body>
    <%- contentFor('body') %>
    <section>
        <form class="song_upload">
            <input type="text" id="title" placeholder="곡 제목">
            <input type="text" id="artist" placeholder="아티스트 명">
            <input type="text" id="album" placeholder="앨범 명">
            <textarea id="lyrics" placeholder="가사"></textarea>
            <input type="text" id="writer" placeholder="작사가">
            <input type="text" id="composer" placeholder="작곡가">
            <select id="genre">
                <option>발라드</option>
                <option>댄스</option>
                <option>랩/힙합</option>
                <option>R&B</option>
                <option>인디음악</option>
                <option>록/메탈</option>
                <option>트로트</option>
                <option>포크</option>
                <option>POP</option>
                <option>컨트리</option>
                <option>EDM</option>
                <option>클래식</option>
                <option>재즈</option>
                <option>CCM</option>
            </select>
            <input type="text" id="playtime" placeholder="재생시간">
            <input type="date" id="release_date" placeholder="발매일">
            <!-- 노래 커버 이미지 업로드 -->
            <input type="file" id="cover"><button type="button" onclick="imgUpload()">업로드</button>
            <input type="file" id="song"><button type="button" onclick="audioUpload()">업로드</button>
        </form>
        <button type="button" onclick="upload()">업로드</button>
    </section>

    <%- contentFor('player') %>

    <script>
        let img_url;
        let audio_url;

        async function imgUpload(event) {
            const file = document.querySelector('#cover');
            console.log(file.files[0]);

            const formData = new FormData();
            //append(key, value)
            //!중요: 파일은 항상 제일 마지막에 선언
            formData.append('imgfile', file.files[0]);

            const res = await axios({
                method: 'POST',
                url: '/dynamic',
                data: formData,
                headers: {
                    'Content-Type': 'multipart/form-data',
                },
            });
            console.log('res', res);
            img_url = res.data.location;
        }

        async function audioUpload(event) {
            const file = document.querySelector('#song');
            console.log(file.files[0]);

            const formData = new FormData();
            //append(key, value)
            //!중요: 파일은 항상 제일 마지막에 선언
            formData.append('songfile', file.files[0]);

            const res = await axios({
                method: 'POST',
                url: '/dynamic',
                data: formData,
                headers: {
                    'Content-Type': 'multipart/form-data',
                },
            });
            console.log('res', res);
            audio_url = res.data.location;
        }

        async function upload(){
            const title = document.getElementById("title").value;
            const artist = document.getElementById("artist").value;
            const album = document.getElementById("album").value;
            const lyrics = document.getElementById("lyrics").value;
            const writer = document.getElementById("writer").value;
            const composer = document.getElementById("composer").value;
            const genre = document.getElementById("genre").value;
            const playtile = document.getElementById("playtime").value;
            const release_date = document.getElementById("release_date").value;
            const cover_url = img_url;
            const song_url = audio_url;
            // const song_url

            // const test = "https://kdt-wonno2.s3.ap-northeast-2.amazonaws.com/audio/DICE.mp3"
            // const test2 = test.split("/")
            // console.log(test2[3] + "/" + test2[4]);

            try{
                const res = await axios({
                    method: 'POST',
                    url: '/song/upload',
                    data: {
                        title, artist, album, lyrics, writer, composer, genre, playtile, release_date, cover_url, song_url
                    }
                });
                console.log(res);
                if(res){
                    alert("완료");
                }
                else{
                    alert("실패");
                }
            }catch(err){
                console.log(err);
            }
            


            console.log("실행");
        }
    </script>
</body>
</html>