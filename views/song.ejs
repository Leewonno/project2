<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>곡정보</title>
</head>
<body>
    
    <%- contentFor('body') %>
    <section>
        <div class="songMain1">
            <div class="albumImg" onclick="music('<%= data.id %>')"><img class="cover" src="<%= data.cover_url %>"></div>
            <div class="albumInfor">
                <div class="title">[EP] <%= data.title %></div>
                <div class="artist"><%= data.artist %></div>
                <div class="album"><%= data.album %></div>
                <div class="writer">작사 <%= data.writer %></div>
                <div class="composer">작곡 <%= data.composer %></div>
                <div class="genre">장르 <%= data.genre %></div>
                <div class="playtime"><%= data.playtime %></div>
                <div class="release_date">발매일 <%= data.release_date %></div>
                <div class="like" onclick="likeBtn()">
                <input type="hidden" value="<%= data.id %>" id="song_id">
                    <% if (likeResult) { %>
                        <i class="fa-solid fa-heart" style="color: #ff6666;"></i> <%= data.like %>
                    <% } else { %>
                        <i class="fa-regular fa-heart" style="color: #ff6666;"></i> <%= data.like %>
                    <% } %>
              
                </div>
            </div>
            <div class="talk"></div>
        </div><br>
        <div class="songMain2">
            <input type="hidden" value="<%= data.lyrics %>" id="lyrics_value">
            <div class="lyrics"></div>
            <div class="anotherSong"></div>
            <div class="songComment">
                <form name="commentCreate" class="commentCreate">
                    <br>

                    <% if (user && user.userid) { %>
                     
                        <img class="comment_profile" src="<%= user.profile_img %>" alt="User Profile Img">
                        <div class="comment_user"><%= user.nickname %>(<%= user.userid %>)</div>
                        <textarea type="text" name="commentText" id="commentText" ></textarea>
                        <button type="button" id="submitBtn" onclick="createComments()">등록</button>
                    </form>
                    <% } else { %>
                        <img src="https://kdt-wonno2.s3.ap-northeast-2.amazonaws.com/img/n_img.png" alt="User Profile Img">
                        <div class="comment_user"></div>
                        <textarea type="text" name="commentText" id="commentText" disabled>로그인 후 이용해주세요</textarea>
                        <div>
                            <button type="button" id="submitBtn" disabled>등록</button>
                        </div>
                        
                    <% } %>
                </form>
                
            </div>
            <br>
            <div class="songCommentList" id="commentList">
                <% for (let i = 0; i < comments.length; i++) { %>
                    <div class="commentItem">
                        <div class="commentListImg"><img src="<%= comments[i].profile_img %>"></div>
                        <div class="comment_user"><%= comments[i].nickname %>(<%= comments[i].userid %>)</div>
                        <div class="commentList_date"><%= comments[i].create_date %></div>
                        <textarea type="text" class="commentList_content" id="<%= comments[i].id %>" readonly><%= comments[i].content %></textarea>
                        <% if (user && user.userid === comments[i].userid) { %>
                            <button type="button" class="modifyBtn" onclick="updateComment('<%= comments[i].id %>')">수정</button>
                            <button type="button" class="deleteBtn" onclick="deleteComment('<%= comments[i].id %>')">삭제</button>
                        <% } %>
                    </div>
                    <br>
                <% } %>
            </div>
        </div>
    </section>

    <script id="sc">
        
        document.querySelector(".lyrics").insertAdjacentHTML("afterbegin", document.getElementById("lyrics_value").value)

        
        async function likeBtn() {
            console.log(this)
            const pushLike = document.querySelector(".like");
            const id = document.getElementById("song_id").value;
          try {
            const response = await axios.post('/song/like', {
                id: id,
            });
            
            console.log(response)
            if (response.data.liked) {
                console.log(response.data.liked)
                // 좋아요가 토글되었을 때 아이콘을 채워진 하트로 변경
                pushLike.innerHTML = '<i class="fa-solid fa-heart" style="color: #ff6666;" ></i> ' + response.data.count;
            } else {
                console.log(response.data.liked)
              // 좋아요가 취소되었을 때 아이콘을 빈 하트로 변경
              pushLike.innerHTML = '<i class="fa-regular fa-heart" style="color: #ff6666;"></i> ' + response.data.count;
            }
          } catch (error) {
            console.error('좋아요 토글에 실패했습니다.', error);
          }
        }

            

        async function createComments() {
            const id = document.getElementById("song_id").value;
            const commentText = document.getElementById("commentText").value;

            try {
                const response = await axios.post(`/song/comment?song_id=${id}`, { content: commentText });


                if (response.status === 200) {
                    const comment = response.data.comment;

                    const commentList = document.getElementById("commentList");
                    const newCommentItem = document.createElement("div");
                    newCommentItem.classList.add("commentItem");
                    newCommentItem.innerHTML = `
                            <img src="${comment.profile_img}">
                            <div class="comment_user">${comment.nickname}(${comment.userid})</div>
                            <div class="commentList_date">${comment.create_date}</div>
                            <textarea type="text" class="commentList_content" id="${comment.id}" readonly>${comment.content}</textarea>
                            <button type="button" class="modifyBtn" onclick="updateComment('${comment.id}')">수정</button>
                            <button type="button" class="deleteBtn" onclick="deleteComment('${comment.id}')">삭제</button>
                        `;
                    commentList.insertBefore(newCommentItem, commentList.firstChild);
                } else {
                    // 오류 처리
                    console.error("댓글 작성 실패");
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function updateComment(num){
            // console.log(document.getElementById("9"));
            document.getElementById(num).removeAttribute("readonly")
            document.getElementById(num).nextElementSibling.textContent = "저장";
            document.getElementById(num).nextElementSibling.setAttribute('onclick', `updateCommentRelease(${num})`);

            document.getElementById(num).nextElementSibling.nextElementSibling.textContent = "취소";
            document.getElementById(num).nextElementSibling.nextElementSibling.setAttribute('onclick', `updateCancel(${num})`);
        }

        async function updateCommentRelease(num){
            console.log("실행");
            const id = Number(num);
            const song_id = document.getElementById("song_id").value;
            const content = document.getElementById(num).value;
            const res = await axios({
                method:"PATCH",
                url:"/song/comment",
                data:{
                    id, song_id, content
                }
            });

            if(res.data.result){
                alert("수정 완료!");
                window.location.reload();
            }
        }

        function updateCancel(num){
            console.log("취소실행");
            document.getElementById(num).setAttribute("readonly", true)
            document.getElementById(num).nextElementSibling.textContent = "수정";
            document.getElementById(num).nextElementSibling.setAttribute('onclick', `updateComment(${num})`);

            document.getElementById(num).nextElementSibling.nextElementSibling.textContent = "삭제";
            document.getElementById(num).nextElementSibling.nextElementSibling.setAttribute('onclick', `deleteComment(${num})`);
        }

        async function deleteComment(num){
            const id = Number(num);
            const res = await axios({
                method:"DELETE",
                url:"/song/comment",
                data:{
                    id
                }
            });

            if(res.data.result){
                alert("삭제 완료!");
                window.location.reload();
            }
        }

        

      </script>

    <%- contentFor('player') %>

    
      
</body>
</html>